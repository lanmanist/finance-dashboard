<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Financial Flow Dashboard v3.2 | Live from Google Sheets</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3-sankey/0.12.3/d3-sankey.min.js"></script>
    <style>
        :root {
            --bg-primary: #0a0f1a;
            --bg-secondary: #111827;
            --bg-card: #1a2234;
            --border: #2a3548;
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --text-muted: #64748b;
            --accent-green: #22c55e;
            --accent-blue: #3b82f6;
            --accent-purple: #a855f7;
            --accent-orange: #f97316;
            --accent-red: #ef4444;
            --accent-teal: #14b8a6;
            --accent-yellow: #eab308;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
        }
        .container { max-width: 1600px; margin: 0 auto; padding: 24px; }
        
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 16px;
        }
        h1 { font-size: 24px; font-weight: 600; }
        h1 span { color: var(--accent-blue); }
        
        .status-bar {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 16px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 13px;
            flex-wrap: wrap;
        }
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--accent-yellow);
            animation: pulse 2s infinite;
        }
        .status-dot.connected { background: var(--accent-green); animation: none; }
        .status-dot.error { background: var(--accent-red); animation: none; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        
        .setup-banner {
            background: linear-gradient(135deg, #1e3a5f 0%, #1a2234 100%);
            border: 1px solid var(--accent-blue);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .setup-banner h3 { color: var(--accent-blue); margin-bottom: 12px; }
        .setup-banner code {
            background: var(--bg-primary);
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 12px;
        }
        .setup-banner ol { margin-left: 20px; line-height: 1.8; }
        .setup-banner .api-input {
            display: flex;
            gap: 8px;
            margin-top: 12px;
        }
        .setup-banner input {
            flex: 1;
            padding: 10px 12px;
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text-primary);
            font-size: 13px;
        }
        
        .controls {
            display: flex;
            gap: 16px;
            flex-wrap: wrap;
            margin-bottom: 20px;
            align-items: center;
        }
        .control-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        label { font-size: 13px; color: var(--text-secondary); }
        select, button {
            padding: 8px 12px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text-primary);
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
        }
        select:hover, button:hover { border-color: var(--accent-blue); }
        button.primary { background: var(--accent-blue); border-color: var(--accent-blue); }
        button.primary:hover { background: #2563eb; }
        button:disabled { opacity: 0.6; cursor: not-allowed; }
        button:disabled:hover { border-color: var(--border); }
        
        .badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
        }
        .badge.bonus { background: rgba(234, 179, 8, 0.2); color: var(--accent-yellow); }
        .badge.rsu { background: rgba(168, 85, 247, 0.2); color: var(--accent-purple); }
        .badge.sondertilgung { background: rgba(239, 68, 68, 0.2); color: var(--accent-red); }
        .badge.post-mortgage { background: rgba(34, 197, 94, 0.2); color: var(--accent-green); }
        .badge.debt-attack { background: rgba(249, 115, 22, 0.2); color: var(--accent-orange); }
        .badge.lean { background: rgba(100, 116, 139, 0.2); color: var(--text-muted); }
        
        .stats-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }
        .stat-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 16px;
            cursor: pointer;
            transition: border-color 0.2s, transform 0.2s;
            position: relative;
        }
        .stat-card:hover { 
            border-color: var(--accent-blue); 
            transform: translateY(-2px);
            z-index: 10;
        }
        .stat-label { font-size: 12px; color: var(--text-muted); margin-bottom: 4px; }
        .stat-value { font-size: 20px; font-weight: 600; }
        .stat-value.positive { color: var(--accent-green); }
        .stat-value.negative { color: var(--accent-red); }
        
        .stat-tooltip {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 12px;
            margin-top: 8px;
            z-index: 100;
            display: none;
            font-size: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
        }
        .stat-card:hover .stat-tooltip { display: block; }
        .stat-tooltip-row {
            display: flex;
            justify-content: space-between;
            padding: 4px 0;
            border-bottom: 1px solid var(--border);
        }
        .stat-tooltip-row:last-child { border-bottom: none; }
        .stat-tooltip-label { color: var(--text-secondary); }
        .stat-tooltip-value { color: var(--text-primary); font-weight: 500; }
        
        .sankey-container {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 24px;
            min-height: 500px;
            position: relative;
        }
        .sankey-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .node rect { cursor: pointer; }
        .node text { font-size: 12px; fill: var(--text-primary); }
        .link { fill: none; stroke-opacity: 0.4; }
        .link:hover { stroke-opacity: 0.7; }
        
        .tooltip {
            position: fixed;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 12px 16px;
            font-size: 13px;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s;
            z-index: 1000;
            max-width: 450px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
        }
        .tooltip.visible { opacity: 1; }
        .tooltip-title { font-weight: 600; margin-bottom: 8px; font-size: 14px; }
        .tooltip-row {
            display: flex;
            justify-content: space-between;
            padding: 3px 0;
            gap: 20px;
        }
        .tooltip-label { color: var(--text-secondary); }
        .tooltip-value { color: var(--accent-green); font-weight: 500; }
        .tooltip-divider { border-top: 1px solid var(--border); margin: 8px 0; }
        .tooltip-hint { font-size: 11px; color: var(--text-muted); margin-top: 8px; font-style: italic; }
        
        .legend {
            display: flex;
            flex-wrap: wrap;
            gap: 16px;
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid var(--border);
        }
        .legend-item {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 12px;
            color: var(--text-secondary);
        }
        .legend-color {
            width: 12px;
            height: 12px;
            border-radius: 3px;
        }
        
        .loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 400px;
            color: var(--text-muted);
            gap: 16px;
        }
        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--border);
            border-top-color: var(--accent-blue);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        .error {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid var(--accent-red);
            border-radius: 8px;
            padding: 16px;
            color: var(--accent-red);
        }
        
        .hidden { display: none !important; }
        
        .sheet-link {
            color: var(--accent-blue);
            text-decoration: none;
            font-size: 12px;
        }
        .sheet-link:hover { text-decoration: underline; }
        
        .view-toggle {
            display: flex;
            background: var(--bg-primary);
            border-radius: 6px;
            padding: 2px;
        }
        .view-toggle button {
            border: none;
            background: transparent;
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 12px;
        }
        .view-toggle button.active {
            background: var(--accent-blue);
            color: white;
        }
        
        /* Loading Overlay - NEW in v3.1 */
        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(10, 15, 26, 0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 50;
            border-radius: 12px;
        }
        .loading-overlay.active { display: flex; }
        .loading-overlay .spinner { width: 32px; height: 32px; }
        .loading-overlay span { margin-left: 12px; color: var(--text-secondary); }
        
        /* Refresh button loading state */
        .btn-refreshing {
            position: relative;
            color: transparent !important;
        }
        .btn-refreshing::after {
            content: '';
            position: absolute;
            width: 16px;
            height: 16px;
            top: 50%;
            left: 50%;
            margin-left: -8px;
            margin-top: -8px;
            border: 2px solid rgba(255,255,255,0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        
        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }
        .modal-overlay.active { display: flex; }
        
        .modal {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 24px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 12px;
            border-bottom: 1px solid var(--border);
        }
        .modal-title { font-size: 18px; font-weight: 600; }
        .modal-close {
            background: none;
            border: none;
            color: var(--text-muted);
            font-size: 24px;
            cursor: pointer;
            padding: 0;
            line-height: 1;
        }
        .modal-close:hover { color: var(--text-primary); }
        
        /* Budget Bar Styles */
        .budget-item {
            margin-bottom: 16px;
        }
        .budget-item-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 6px;
            font-size: 13px;
        }
        .budget-item-name { color: var(--text-primary); }
        .budget-item-values { color: var(--text-secondary); }
        .budget-bar {
            height: 8px;
            background: var(--bg-primary);
            border-radius: 4px;
            overflow: hidden;
        }
        .budget-bar-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.3s;
        }
        .budget-bar-fill.green { background: var(--accent-green); }
        .budget-bar-fill.yellow { background: var(--accent-yellow); }
        .budget-bar-fill.orange { background: var(--accent-orange); }
        .budget-bar-fill.red { background: var(--accent-red); }
        
        .budget-summary {
            display: flex;
            justify-content: space-between;
            padding: 12px;
            background: var(--bg-card);
            border-radius: 8px;
            margin-top: 16px;
            font-weight: 600;
        }
        
        .budget-na {
            color: var(--text-muted);
            font-style: italic;
            text-align: center;
            padding: 20px;
        }
        
        /* Expense Table Styles */
        .expense-table-container {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 24px;
            margin-top: 24px;
        }
        .expense-table-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }
        .expense-table-header h3 {
            font-size: 16px;
            font-weight: 600;
            margin: 0;
        }
        .expense-table-period {
            font-size: 13px;
            color: var(--text-secondary);
        }
        .expense-table-loading {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            padding: 40px;
            color: var(--text-muted);
        }
        .expense-table-error {
            text-align: center;
            padding: 40px;
            color: var(--accent-red);
            background: rgba(239, 68, 68, 0.1);
            border-radius: 8px;
        }
        .expense-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
            table-layout: fixed;
        }
        .expense-table th,
        .expense-table td {
            padding: 14px 12px;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }
        .expense-table th {
            color: var(--text-muted);
            font-weight: 500;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .expense-table th:nth-child(1) { width: 35%; }
        .expense-table th:nth-child(2) { width: 15%; }
        .expense-table th:nth-child(3) { width: 15%; }
        .expense-table th:nth-child(4) { width: 12%; }
        .expense-table th:nth-child(5) { width: 23%; }
        .expense-table .text-right {
            text-align: right;
        }
        .expense-table tbody tr {
            cursor: pointer;
            transition: background 0.15s;
        }
        .expense-table tbody tr:hover {
            background: rgba(59, 130, 246, 0.08);
        }
        .expense-table tfoot td {
            font-weight: 600;
            background: var(--bg-secondary);
            border-top: 2px solid var(--border);
        }
        .expense-category {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 14px;
            font-weight: 500;
        }
        .expense-category-emoji {
            font-size: 18px;
            width: 24px;
            text-align: center;
        }
        .expense-status {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
        }
        .expense-status.green { background: rgba(34, 197, 94, 0.2); color: var(--accent-green); }
        .expense-status.yellow { background: rgba(234, 179, 8, 0.2); color: var(--accent-yellow); }
        .expense-status.orange { background: rgba(249, 115, 22, 0.2); color: var(--accent-orange); }
        .expense-status.red { background: rgba(239, 68, 68, 0.2); color: var(--accent-red); }
        .expense-status.na { background: rgba(100, 116, 139, 0.2); color: var(--text-muted); }
        
        /* Expense Tooltip */
        .expense-tooltip {
            position: fixed;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 0;
            min-width: 340px;
            max-width: 400px;
            z-index: 2000;
            box-shadow: 0 12px 40px rgba(0,0,0,0.5);
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.15s;
            overflow: hidden;
        }
        .expense-tooltip.visible { opacity: 1; }
        .expense-tooltip-header {
            background: var(--bg-card);
            padding: 14px 16px;
            border-bottom: 1px solid var(--border);
        }
        .expense-tooltip-title {
            font-size: 15px;
            font-weight: 600;
            margin-bottom: 4px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .expense-tooltip-subtitle {
            font-size: 12px;
            color: var(--text-secondary);
        }
        .expense-tooltip-section {
            padding: 12px 16px;
            border-bottom: 1px solid var(--border);
        }
        .expense-tooltip-section:last-child {
            border-bottom: none;
        }
        .expense-tooltip-section-title {
            font-size: 11px;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .expense-tooltip-txn {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 5px 0;
            font-size: 12px;
            border-bottom: 1px dashed var(--border);
        }
        .expense-tooltip-txn:last-child {
            border-bottom: none;
        }
        .expense-tooltip-txn-date {
            color: var(--text-muted);
            width: 45px;
            flex-shrink: 0;
        }
        .expense-tooltip-txn-merchant {
            color: var(--text-primary);
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            padding: 0 8px;
        }
        .expense-tooltip-txn-amount {
            color: var(--accent-green);
            font-weight: 500;
            flex-shrink: 0;
        }
        .expense-tooltip-insight {
            font-size: 12px;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .expense-tooltip-insight span {
            color: var(--accent-blue);
            font-weight: 500;
        }
        
        /* Debt Detail Styles */
        .debt-section {
            margin-bottom: 20px;
        }
        .debt-section-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .debt-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 12px;
            background: var(--bg-card);
            border-radius: 6px;
            margin-bottom: 8px;
        }
        .debt-item-name { color: var(--text-primary); }
        .debt-item-values { 
            display: flex;
            gap: 20px;
            color: var(--text-secondary);
            font-size: 13px;
        }
        .debt-item-values span { min-width: 80px; text-align: right; }
        .debt-item-values .payment { color: var(--accent-orange); }
        .debt-item-values .balance { color: var(--text-muted); }
        
        /* CMP Flow Indicator */
        .cmp-flow-section {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 20px;
        }
        .cmp-flow-title {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 12px;
            color: var(--accent-blue);
        }
        .cmp-flow-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px dashed var(--border);
        }
        .cmp-flow-row:last-child { border-bottom: none; }
        .cmp-flow-row.highlight { 
            background: rgba(59, 130, 246, 0.1);
            margin: 0 -8px;
            padding: 8px;
            border-radius: 4px;
        }
        .cmp-flow-label { color: var(--text-secondary); }
        .cmp-flow-value { font-weight: 600; }
        .cmp-flow-value.inflow { color: var(--accent-green); }
        .cmp-flow-value.outflow { color: var(--accent-red); }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üí∞ Financial Flow <span>Dashboard v3.1</span></h1>
            <div class="control-group">
                <a href="https://docs.google.com/spreadsheets/d/1mrMCTbgPxjxbkHepDiQk_ddN0cbJ-A-GWWtwt3wOgSU/edit" 
                   target="_blank" class="sheet-link">üìä Open Google Sheet</a>
                <button id="refreshBtn" onclick="refreshData()" class="primary">üîÑ Refresh</button>
            </div>
        </header>
        
        <div class="setup-banner hidden" id="setupBanner">
            <h3>‚öôÔ∏è¬è One-Time Setup Required</h3>
            <ol>
                <li>Open your Google Sheet</li>
                <li>Go to <strong>Extensions ‚Üí Apps Script</strong></li>
                <li>Paste the <code>Code.gs</code> content and save</li>
                <li>Deploy as Web App with "Anyone" access</li>
                <li>Paste the URL below:</li>
            </ol>
            <div class="api-input">
                <input type="text" id="apiUrlInput" placeholder="https://script.google.com/macros/s/AKfycb.../exec">
                <button onclick="saveApiUrl()" class="primary">Save & Connect</button>
            </div>
        </div>
        
        <div class="status-bar">
            <div class="status-dot" id="statusDot"></div>
            <span id="statusText">Not connected</span>
            <span id="expenseLoadingIndicator" class="hidden" style="color: var(--accent-purple);">Loading expenses...</span>
            <span style="margin-left: auto; color: var(--text-muted);" id="lastUpdate"></span>
        </div>
        
        <div class="controls" id="controls">
            <div class="control-group">
                <label>View:</label>
                <div class="view-toggle">
                    <button id="btnSimple" class="active" onclick="setViewMode('simple')">Simple</button>
                    <button id="btnDetailed" onclick="setViewMode('detailed')">Detailed</button>
                </div>
            </div>
            <div class="control-group">
                <label>Expenses:</label>
                <div class="view-toggle">
                    <button id="btnExpCollapsed" class="active" onclick="setExpenseView('collapsed')">Collapsed</button>
                    <button id="btnExpExpanded" onclick="setExpenseView('expanded')">Expanded</button>
                </div>
            </div>
            <div class="control-group">
                <label>Year:</label>
                <select id="yearSelect" onchange="updateMonthOptions(); render();"></select>
            </div>
            <div class="control-group">
                <label>From:</label>
                <select id="monthFromSelect" onchange="validateMonthRange(); render();"></select>
            </div>
            <div class="control-group">
                <label>To:</label>
                <select id="monthToSelect" onchange="validateMonthRange(); render();"></select>
            </div>
        </div>
        
        <!-- CMP Flow Section (for single month view) -->
        <div class="cmp-flow-section hidden" id="cmpFlowSection">
            <div class="cmp-flow-title">üí≥ Central Master Pot (CMP) Flow</div>
            <div id="cmpFlowContent"></div>
        </div>
        
        <div id="statsRow" class="stats-row"></div>
        
        <div class="sankey-container">
            <div class="sankey-title">
                <span>üí∏ Money Flow</span>
                <span id="flowTitle"></span>
                <span id="monthBadges"></span>
            </div>
            <!-- Loading Overlay - NEW in v3.1 -->
            <div class="loading-overlay" id="loadingOverlay">
                <div class="spinner"></div>
                <span>Updating...</span>
            </div>
            <div id="sankey"></div>
            <div class="legend" id="legend"></div>
        </div>
        
        <!-- Expense Table Section -->
        <div class="expense-table-container" id="expenseTableContainer">
            <div class="expense-table-header">
                <h3>üìã Expense Summary</h3>
                <span class="expense-table-period" id="expenseTablePeriod"></span>
            </div>
            <div class="expense-table-loading" id="expenseTableLoading">
                <div class="spinner"></div>
                <span>Loading expense data...</span>
            </div>
            <div class="expense-table-error" id="expenseTableError" style="display: none;"></div>
            <table class="expense-table" id="expenseTable" style="display: none;">
                <thead>
                    <tr>
                        <th>Category</th>
                        <th class="text-right">Spent</th>
                        <th class="text-right">Budget</th>
                        <th class="text-right">%</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody id="expenseTableBody"></tbody>
                <tfoot id="expenseTableFoot"></tfoot>
            </table>
        </div>
    </div>
    
    <div id="tooltip" class="tooltip"></div>
    
    <!-- Expense Tooltip -->
    <div id="expenseTooltip" class="expense-tooltip"></div>
    
    <!-- Expense Modal -->
    <div class="modal-overlay" id="expenseModal">
        <div class="modal">
            <div class="modal-header">
                <span class="modal-title">üìä Expense Breakdown</span>
                <button class="modal-close" onclick="closeModal('expenseModal')">&times;</button>
            </div>
            <div id="expenseModalContent">
                <div class="loading"><div class="spinner"></div><span>Loading expense data...</span></div>
            </div>
        </div>
    </div>
    
    <!-- Debt Modal -->
    <div class="modal-overlay" id="debtModal">
        <div class="modal">
            <div class="modal-header">
                <span class="modal-title" id="debtModalTitle">üí≥ Debt Breakdown</span>
                <button class="modal-close" onclick="closeModal('debtModal')">&times;</button>
            </div>
            <div id="debtModalContent"></div>
        </div>
    </div>

<script>
// ============ CONFIGURATION ============
let API_URL = localStorage.getItem('sankey_api_url') || '';
let viewMode = 'simple';
let expenseView = 'collapsed'; // NEW in v3.1: 'collapsed' | 'expanded'

const colors = {
    h_gross: '#16a34a',
    w_gross: '#059669',
    tax: '#ef4444',
    ta_deduction: '#0ea5e9',
    ownsap_ded: '#c2410c',
    h_salary: '#22c55e',
    w_salary: '#10b981',
    h_rsu: '#a855f7',
    w_rsu: '#c084fc',
    youtube: '#ef4444',
    ownsap_sell: '#f97316',
    cmp: '#3b82f6',
    cmp_carry: '#60a5fa',
    cmp_next: '#93c5fd',
    mortgage: '#64748b',
    sondertilgung: '#dc2626',
    high_apr: '#f43f5e',
    low_apr: '#fb7185',
    fixed_debt: '#fb923c',
    sap_loan: '#94a3b8',
    expenses: '#8b5cf6',
    investment: '#06b6d4',
    ownsap_inv: '#0ea5e9',
    cashpile: '#14b8a6',
};

// NEW in v3.1: Category colors for expense breakdown
const categoryColors = {
    'Childcare': '#7c3aed',
    'Family Support': '#8b5cf6',
    'Groceries + Food': '#a78bfa',
    'Utilities': '#6366f1',
    'Car': '#818cf8',
    'Shopping': '#c4b5fd',
    'Travel & Leisure': '#4f46e5',
    'Insurance': '#6d28d9',
    'Eat Out & Food delivery': '#a855f7',
    'Gifts': '#d946ef',
    'Entertainment': '#e879f9',
    'Health & beauty': '#f0abfc',
    'Home improvement': '#c026d3',
    'Business & Subscription': '#9333ea',
    'Donation': '#7e22ce',
    'Special IO': '#581c87',
    'Buffer': '#4c1d95'
};

// Category emoji mapping
const categoryEmojis = {
    'Childcare': 'üë∂',
    'Family Support': 'üë®‚Äçüë©‚Äçüëß',
    'Groceries + Food': 'üõí',
    'Utilities': 'üí°',
    'Car': 'üöó',
    'Shopping': 'üõçÔ∏è',
    'Travel & Leisure': '‚úàÔ∏è',
    'Insurance': 'üõ°Ô∏è',
    'Eat Out & Food delivery': 'üçî',
    'Gifts': 'üéÅ',
    'Entertainment': 'üé¨',
    'Health & beauty': 'üíÑ',
    'Home improvement': 'üîß',
    'Business & Subscription': 'üíº',
    'Donation': '‚ù§Ô∏è',
    'Special IO': '‚ö°',
    'Buffer': 'üîÑ',
    'Fees, Interest, Bureaucracy, Documents': 'üìã'
};

function getCategoryEmoji(name) {
    return categoryEmojis[name] || 'üì¶';
}

function formatPercentGerman(percent) {
    if (percent === null || percent === undefined) return '‚Äî';
    // German format: use . as thousand separator
    return percent.toLocaleString('de-DE') + '%';
}

let allData = [];
let currentYear = 2026;
let monthFrom = 1;
let monthTo = 1;
let expenseCache = {};
let currentExpenseData = null;

// ============ INITIALIZATION ============

document.addEventListener('DOMContentLoaded', init);

function init() {
    console.log('[Init] Starting...');
    
    // Clear expense cache
    expenseCache = {};
    
    // Clean API_URL to just the base (no query params)
    if (API_URL) {
        const cleanUrl = API_URL.split('?')[0];
        if (cleanUrl !== API_URL) {
            console.log('[Init] Cleaned URL from', API_URL, 'to', cleanUrl);
            API_URL = cleanUrl;
            localStorage.setItem('sankey_api_url', cleanUrl);
        }
    }
    
    console.log('[Init] API_URL:', API_URL);
    
    if (API_URL) {
        document.getElementById('setupBanner').classList.add('hidden');
        refreshData();
    } else {
        document.getElementById('setupBanner').classList.remove('hidden');
        document.getElementById('controls').classList.add('hidden');
    }
    
    // Close modals on overlay click
    document.querySelectorAll('.modal-overlay').forEach(overlay => {
        overlay.addEventListener('click', (e) => {
            if (e.target === overlay) {
                overlay.classList.remove('active');
            }
        });
    });
    
    // Close modals on Escape key
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
            document.querySelectorAll('.modal-overlay.active').forEach(m => m.classList.remove('active'));
        }
    });
}

function saveApiUrl() {
    let url = document.getElementById('apiUrlInput').value.trim();
    if (!url.startsWith('https://script.google.com/')) {
        alert('Please enter a valid Google Apps Script URL');
        return;
    }
    
    // Just keep the base URL (before any ?)
    url = url.split('?')[0];
    
    API_URL = url;
    localStorage.setItem('sankey_api_url', url);
    console.log('[Init] Saved API_URL:', url);
    
    document.getElementById('setupBanner').classList.add('hidden');
    document.getElementById('controls').classList.remove('hidden');
    refreshData();
}

function setViewMode(mode) {
    viewMode = mode;
    document.getElementById('btnSimple').classList.toggle('active', mode === 'simple');
    document.getElementById('btnDetailed').classList.toggle('active', mode === 'detailed');
    render();
}

// NEW in v3.1: Expense view toggle handler
function setExpenseView(view) {
    expenseView = view;
    document.getElementById('btnExpCollapsed').classList.toggle('active', view === 'collapsed');
    document.getElementById('btnExpExpanded').classList.toggle('active', view === 'expanded');
    render();
}

// NEW in v3.1: Get color for a category
function getCategoryColor(categoryName) {
    return categoryColors[categoryName] || colors.expenses;
}

// ============ LOADING STATES - NEW in v3.1 ============

function showLoadingOverlay() {
    document.getElementById('loadingOverlay').classList.add('active');
}

function hideLoadingOverlay() {
    document.getElementById('loadingOverlay').classList.remove('active');
}

function setRefreshButtonLoading(loading) {
    const btn = document.getElementById('refreshBtn');
    if (loading) {
        btn.classList.add('btn-refreshing');
        btn.disabled = true;
    } else {
        btn.classList.remove('btn-refreshing');
        btn.disabled = false;
    }
}

function showExpenseLoadingIndicator(show) {
    const indicator = document.getElementById('expenseLoadingIndicator');
    if (show) {
        indicator.classList.remove('hidden');
    } else {
        indicator.classList.add('hidden');
    }
}

// ============ DATA FETCHING ============

async function refreshData() {
    if (!API_URL) {
        document.getElementById('setupBanner').classList.remove('hidden');
        return;
    }
    
    // Clear expense cache on refresh
    expenseCache = {};
    currentExpenseData = null;
    
    const statusDot = document.getElementById('statusDot');
    const statusText = document.getElementById('statusText');
    
    setRefreshButtonLoading(true);
    statusDot.className = 'status-dot';
    statusText.textContent = 'Connecting to Google Sheets...';
    document.getElementById('sankey').innerHTML = '<div class="loading"><div class="spinner"></div><span>Loading live data...</span></div>';
    
    try {
        // Simple URL construction
        const baseUrl = API_URL.split('?')[0];
        const apiUrlWithAction = `${baseUrl}?action=dashboard`;
        console.log('[Dashboard] Fetching:', apiUrlWithAction);
        
        const res = await fetch(apiUrlWithAction);
        const json = await res.json();
        
        if (json.success && json.data) {
            allData = json.data;
            statusDot.className = 'status-dot connected';
            statusText.textContent = `Live ‚Ä¢ ${json.count} months loaded`;
            document.getElementById('lastUpdate').textContent = `Updated: ${new Date().toLocaleTimeString()}`;
            
            populateSelects();
            await render();
        } else {
            throw new Error(json.error || 'Failed to load data');
        }
    } catch (err) {
        statusDot.className = 'status-dot error';
        statusText.textContent = `Error: ${err.message}`;
        document.getElementById('sankey').innerHTML = `<div class="error">${err.message}</div>`;
    } finally {
        setRefreshButtonLoading(false); // NEW in v3.1
    }
}

async function fetchExpenseData(month) {
    // Check cache - but validate it has the right structure
    if (expenseCache[month] && expenseCache[month].categories && expenseCache[month].summary) {
        console.log('[Expense] Valid cache hit for', month);
        return expenseCache[month];
    } else if (expenseCache[month]) {
        console.log('[Expense] Invalid cache entry for', month, '- refetching');
        delete expenseCache[month];
    }
    
    try {
        // Build clean URL
        let baseUrl = API_URL.split('?')[0];  // Just get base URL without any params
        const apiUrlWithAction = `${baseUrl}?action=expenses&month=${month}`;
        
        console.log('[Expense] Fetching:', apiUrlWithAction);
        
        // Simple fetch - NO custom headers (causes CORS preflight with Google Apps Script)
        const res = await fetch(apiUrlWithAction);
        const json = await res.json();
        
        console.log('[Expense] Response keys:', Object.keys(json));
        
        // Check what we got
        if (json.categories && json.summary) {
            console.log('[Expense] ‚úì Got expense data');
            expenseCache[month] = json;
            return json;
        } else if (json.data) {
            console.error('[Expense] ‚úó Got dashboard data instead');
            return { success: false, error: 'Got dashboard data - redeploy Code.gs' };
        } else {
            return { success: false, error: json.error || 'Unknown response' };
        }
    } catch (err) {
        console.error('[Expense] Fetch error:', err.message);
        return { success: false, error: err.message };
    }
}

async function prefetchExpenseData() {
    showExpenseLoadingIndicator(true);
    updateExpenseTableLoading(true);
    
    const months = [];
    for (let m = monthFrom; m <= monthTo; m++) {
        months.push(getMonthKey(currentYear, m));
    }
    
    console.log('[Expense] Prefetching:', months);
    
    try {
        const results = await Promise.all(months.map(m => fetchExpenseData(m)));
        currentExpenseData = aggregateExpenseData(results);
        
        if (currentExpenseData && currentExpenseData.success !== false && currentExpenseData.categories) {
            console.log('[Expense] ‚úì Data loaded');
            updateExpenseTable();
        } else {
            console.warn('[Expense] ‚úó', currentExpenseData?.error);
            updateExpenseTableError(currentExpenseData?.error || 'No expense data');
        }
    } catch (err) {
        console.error('[Expense] Error:', err);
        currentExpenseData = null;
        updateExpenseTableError(err.message);
    } finally {
        showExpenseLoadingIndicator(false);
    }
}

// ============ EXPENSE TABLE FUNCTIONS ============

function updateExpenseTableLoading(show) {
    const loading = document.getElementById('expenseTableLoading');
    const table = document.getElementById('expenseTable');
    const error = document.getElementById('expenseTableError');
    
    if (show) {
        loading.style.display = 'flex';
        table.style.display = 'none';
        error.style.display = 'none';
    } else {
        loading.style.display = 'none';
    }
}

function updateExpenseTableError(message) {
    const loading = document.getElementById('expenseTableLoading');
    const table = document.getElementById('expenseTable');
    const error = document.getElementById('expenseTableError');
    
    loading.style.display = 'none';
    table.style.display = 'none';
    error.style.display = 'block';
    error.innerHTML = `‚ö†Ô∏è ${message || 'Failed to load expense data'}`;
}

function updateExpenseTable() {
    const loading = document.getElementById('expenseTableLoading');
    const table = document.getElementById('expenseTable');
    const error = document.getElementById('expenseTableError');
    const tbody = document.getElementById('expenseTableBody');
    const tfoot = document.getElementById('expenseTableFoot');
    const period = document.getElementById('expenseTablePeriod');
    
    loading.style.display = 'none';
    error.style.display = 'none';
    
    if (!currentExpenseData || !currentExpenseData.success) {
        updateExpenseTableError(currentExpenseData?.error || 'No expense data available');
        return;
    }
    
    if (!currentExpenseData.categories || !currentExpenseData.summary) {
        updateExpenseTableError('Expense data incomplete - check ShadowLedger configuration');
        return;
    }
    
    // Set period text
    period.textContent = currentExpenseData.month_name || '';
    
    // Build table body with emoji and hover support
    let html = '';
    currentExpenseData.categories.forEach((cat, idx) => {
        if (!cat) return;
        if (cat.spent === 0 && (!cat.budget || cat.budget === 0)) return;
        
        const emoji = getCategoryEmoji(cat.name);
        const budgetStr = cat.budget !== null ? fmt(cat.budget) : '‚Äî';
        const percentStr = formatPercentGerman(cat.percent);
        const statusClass = getExpenseStatusClass(cat.percent);
        const statusText = getExpenseStatusText(cat.percent);
        
        html += `
            <tr data-category-idx="${idx}" 
                onmouseenter="showExpenseTooltip(event, ${idx})" 
                onmousemove="moveExpenseTooltip(event)"
                onmouseleave="hideExpenseTooltip()">
                <td>
                    <div class="expense-category">
                        <span class="expense-category-emoji">${emoji}</span>
                        <span>${cat.name || 'Unknown'}</span>
                    </div>
                </td>
                <td class="text-right">${fmt(cat.spent || 0)}</td>
                <td class="text-right">${budgetStr}</td>
                <td class="text-right">${percentStr}</td>
                <td><span class="expense-status ${statusClass}">${statusText}</span></td>
            </tr>
        `;
    });
    tbody.innerHTML = html;
    
    // Build footer totals
    const summary = currentExpenseData.summary;
    const totalBudget = summary.total_budget ? fmt(summary.total_budget) : '‚Äî';
    const totalPercent = formatPercentGerman(summary.total_percent);
    const totalStatusClass = getExpenseStatusClass(summary.total_percent);
    const totalStatusText = getExpenseStatusText(summary.total_percent);
    
    tfoot.innerHTML = `
        <tr>
            <td>
                <div class="expense-category">
                    <span class="expense-category-emoji">üìä</span>
                    <strong>Total</strong> <span style="font-weight:normal; color: var(--text-muted);">(${summary.transaction_count || 0} txns)</span>
                </div>
            </td>
            <td class="text-right">${fmt(summary.total_spent || 0)}</td>
            <td class="text-right">${totalBudget}</td>
            <td class="text-right">${totalPercent}</td>
            <td><span class="expense-status ${totalStatusClass}">${totalStatusText}</span></td>
        </tr>
    `;
    
    table.style.display = 'table';
}

// ============ EXPENSE TOOLTIP FUNCTIONS ============

function showExpenseTooltip(event, categoryIdx) {
    const tooltip = document.getElementById('expenseTooltip');
    const cat = currentExpenseData?.categories?.[categoryIdx];
    
    if (!cat) {
        tooltip.classList.remove('visible');
        return;
    }
    
    const emoji = getCategoryEmoji(cat.name);
    const budgetStr = cat.budget !== null ? fmt(cat.budget) : 'No budget';
    const percentStr = cat.percent !== null ? `${cat.percent}%` : '';
    const txnCount = cat.transaction_count || cat.transactions_recent?.length || 0;
    
    let html = `
        <div class="expense-tooltip-header">
            <div class="expense-tooltip-title">${emoji} ${cat.name}</div>
            <div class="expense-tooltip-subtitle">${fmt(cat.spent)} / ${budgetStr} ${percentStr ? `(${percentStr})` : ''} ‚Ä¢ ${txnCount} transactions</div>
        </div>
    `;
    
    // Recent transactions section
    if (cat.transactions_recent && cat.transactions_recent.length > 0) {
        html += `
            <div class="expense-tooltip-section">
                <div class="expense-tooltip-section-title">üìÖ Recent Transactions</div>
        `;
        cat.transactions_recent.forEach(txn => {
            html += `
                <div class="expense-tooltip-txn">
                    <span class="expense-tooltip-txn-date">${txn.date}</span>
                    <span class="expense-tooltip-txn-merchant">${txn.merchant}</span>
                    <span class="expense-tooltip-txn-amount">${fmt(txn.amount)}</span>
                </div>
            `;
        });
        html += `</div>`;
    }
    
    // Top transactions section
    if (cat.transactions_top && cat.transactions_top.length > 0) {
        html += `
            <div class="expense-tooltip-section">
                <div class="expense-tooltip-section-title">üí∞ Top Transactions</div>
        `;
        cat.transactions_top.forEach(txn => {
            html += `
                <div class="expense-tooltip-txn">
                    <span class="expense-tooltip-txn-date">${txn.date}</span>
                    <span class="expense-tooltip-txn-merchant">${txn.merchant}</span>
                    <span class="expense-tooltip-txn-amount">${fmt(txn.amount)}</span>
                </div>
            `;
        });
        html += `</div>`;
    }
    
    // Insights section
    if (cat.insights) {
        const ins = cat.insights;
        html += `
            <div class="expense-tooltip-section">
                <div class="expense-tooltip-insight">
                    üí° Avg: <span>${fmt(ins.avg_amount || 0)}</span> per txn
                    ${ins.largest_amount ? ` ‚Ä¢ Largest: <span>${fmt(ins.largest_amount)}</span> on ${ins.largest_date}` : ''}
                </div>
            </div>
        `;
    } else if (!cat.transactions_recent) {
        // No transaction data yet - show helpful message
        html += `
            <div class="expense-tooltip-section">
                <div class="expense-tooltip-insight" style="color: var(--text-muted);">
                    üí° Update Code.gs and redeploy to see transaction details
                </div>
            </div>
        `;
    }
    
    tooltip.innerHTML = html;
    tooltip.classList.add('visible');
    moveExpenseTooltip(event);
}

function moveExpenseTooltip(event) {
    const tooltip = document.getElementById('expenseTooltip');
    const tooltipRect = tooltip.getBoundingClientRect();
    const padding = 15;
    
    let x = event.clientX + padding;
    let y = event.clientY - padding;
    
    // Prevent going off-screen right
    if (x + tooltipRect.width > window.innerWidth - padding) {
        x = event.clientX - tooltipRect.width - padding;
    }
    
    // Prevent going off-screen bottom
    if (y + tooltipRect.height > window.innerHeight - padding) {
        y = window.innerHeight - tooltipRect.height - padding;
    }
    
    // Prevent going off-screen top
    if (y < padding) {
        y = padding;
    }
    
    // Prevent going off-screen left
    if (x < padding) {
        x = padding;
    }
    
    tooltip.style.left = `${x}px`;
    tooltip.style.top = `${y}px`;
}

function hideExpenseTooltip() {
    document.getElementById('expenseTooltip').classList.remove('visible');
}

function getExpenseStatusClass(percent) {
    if (percent === null || percent === undefined) return 'na';
    if (percent >= 100) return 'red';
    if (percent >= 80) return 'orange';
    if (percent >= 50) return 'yellow';
    return 'green';
}

function getExpenseStatusText(percent) {
    if (percent === null || percent === undefined) return 'N/A';
    if (percent >= 100) return 'Over Budget';
    if (percent >= 80) return 'Warning';
    if (percent >= 50) return 'On Track';
    return 'Good';
}

// ============ UI HELPERS ============

function fmt(val) {
    return new Intl.NumberFormat('de-DE', { 
        style: 'currency', currency: 'EUR',
        minimumFractionDigits: 0, maximumFractionDigits: 0
    }).format(val);
}

function populateSelects() {
    const years = [...new Set(allData.map(d => d.year))].sort();
    const yearSelect = document.getElementById('yearSelect');
    yearSelect.innerHTML = years.map(y => `<option value="${y}">${y}</option>`).join('');
    yearSelect.value = currentYear;
    updateMonthOptions();
}

function updateMonthOptions() {
    currentYear = parseInt(document.getElementById('yearSelect').value);
    const months = allData.filter(d => d.year === currentYear).map(d => d.month);
    const monthNames = ['', 'Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
    
    const fromSelect = document.getElementById('monthFromSelect');
    const toSelect = document.getElementById('monthToSelect');
    
    const options = months.map(m => `<option value="${m}">${monthNames[m]}</option>`).join('');
    fromSelect.innerHTML = options;
    toSelect.innerHTML = options;
    
    if (months.includes(monthFrom)) {
        fromSelect.value = monthFrom;
    } else {
        monthFrom = months[0];
        fromSelect.value = monthFrom;
    }
    
    if (months.includes(monthTo) && monthTo >= monthFrom) {
        toSelect.value = monthTo;
    } else {
        monthTo = monthFrom;
        toSelect.value = monthTo;
    }
}

function validateMonthRange() {
    monthFrom = parseInt(document.getElementById('monthFromSelect').value);
    monthTo = parseInt(document.getElementById('monthToSelect').value);
    
    if (monthTo < monthFrom) {
        monthTo = monthFrom;
        document.getElementById('monthToSelect').value = monthTo;
    }
}

function getSelectedData() {
    return allData.filter(d => 
        d.year === currentYear && 
        d.month >= monthFrom && 
        d.month <= monthTo
    );
}

function isSingleMonthView() {
    return monthFrom === monthTo;
}

function getMonthKey(year, month) {
    return `${year}-${String(month).padStart(2, '0')}`;
}

function aggregateData(dataArr) {
    if (dataArr.length === 0) return null;
    if (dataArr.length === 1) return dataArr[0];
    
    const agg = JSON.parse(JSON.stringify(dataArr[0]));
    
    const sumFields = (obj, source) => {
        for (const key in obj) {
            if (typeof obj[key] === 'number') {
                obj[key] = dataArr.reduce((sum, d) => sum + (source ? d[source][key] : d[key]) || 0, 0);
            }
        }
    };
    
    sumFields(agg.gross, 'gross');
    sumFields(agg.deductions, 'deductions');
    sumFields(agg.inflows, 'inflows');
    sumFields(agg.outflows, 'outflows');
    
    const last = dataArr[dataArr.length - 1];
    agg.balances = last.balances;
    agg.investment_details = last.investment_details;
    agg.mortgage_details = last.mortgage_details;
    agg.net_worth_breakdown = last.net_worth_breakdown;
    agg.debt_details = last.debt_details;
    agg.cmp_details = last.cmp_details;
    
    agg.investment_details.ownsap_contrib = dataArr.reduce((s, d) => s + d.investment_details.ownsap_contrib, 0);
    agg.investment_details.excess_contrib = dataArr.reduce((s, d) => s + d.investment_details.excess_contrib, 0);
    agg.investment_details.growth = dataArr.reduce((s, d) => s + d.investment_details.growth, 0);
    agg.investment_details.begin = dataArr[0].investment_details.begin;
    
    agg.is_bonus_month = dataArr.some(d => d.is_bonus_month);
    agg.is_rsu_month = dataArr.some(d => d.is_rsu_month);
    agg.is_sondertilgung_month = dataArr.some(d => d.is_sondertilgung_month);
    agg.is_post_mortgage = dataArr.every(d => d.is_post_mortgage);
    agg.is_debt_attack_phase = dataArr.some(d => d.is_debt_attack_phase);
    
    agg.cmp_details.carry = dataArr[0].cmp_details.carry;
    agg.cmp_details.end = last.cmp_details.end;
    
    return agg;
}

function closeModal(modalId) {
    document.getElementById(modalId).classList.remove('active');
}

function openModal(modalId) {
    document.getElementById(modalId).classList.add('active');
}

// ============ RENDERING ============

async function render() {
    const dataArr = getSelectedData();
    if (!dataArr.length) return;
    
    showLoadingOverlay(); // NEW in v3.1
    
    const data = aggregateData(dataArr);
    const monthNames = ['', 'January', 'February', 'March', 'April', 'May', 'June', 
                        'July', 'August', 'September', 'October', 'November', 'December'];
    
    // Pre-fetch expense data for hover tooltips
    await prefetchExpenseData();
    
    let title = '';
    if (monthFrom === monthTo) {
        title = `${monthNames[monthFrom]} ${currentYear}`;
    } else {
        title = `${monthNames[monthFrom]} - ${monthNames[monthTo]} ${currentYear}`;
    }
    document.getElementById('flowTitle').textContent = title;
    
    let badges = [];
    if (data.is_debt_attack_phase) badges.push('<span class="badge debt-attack">Debt Attack</span>');
    if (data.is_bonus_month) badges.push('<span class="badge bonus">Bonus</span>');
    if (data.is_rsu_month) badges.push('<span class="badge rsu">RSU</span>');
    if (data.is_sondertilgung_month) badges.push('<span class="badge sondertilgung">Sondertilgung</span>');
    if (data.is_post_mortgage) badges.push('<span class="badge post-mortgage">Post-Mortgage</span>');
    if (badges.length === 0) badges.push('<span class="badge lean">Standard</span>');
    document.getElementById('monthBadges').innerHTML = badges.join('');
    
    renderCMPFlowSection(data, dataArr);
    renderStats(data);
    renderSankey(data, dataArr);
    
    hideLoadingOverlay(); // NEW in v3.1
}

function renderCMPFlowSection(data, dataArr) {
    const section = document.getElementById('cmpFlowSection');
    const content = document.getElementById('cmpFlowContent');
    
    if (!isSingleMonthView()) {
        section.classList.add('hidden');
        return;
    }
    
    section.classList.remove('hidden');
    
    const cmpDet = data.cmp_details;
    const monthNames = ['', 'January', 'February', 'March', 'April', 'May', 'June', 
                        'July', 'August', 'September', 'October', 'November', 'December'];
    
    let nextMonth = monthFrom + 1;
    let nextYear = currentYear;
    if (nextMonth > 12) {
        nextMonth = 1;
        nextYear++;
    }
    const nextMonthName = `${monthNames[nextMonth]} ${nextYear}`;
    const currentMonthName = `${monthNames[monthFrom]} ${currentYear}`;
    
    let prevMonth = monthFrom - 1;
    let prevYear = currentYear;
    if (prevMonth < 1) {
        prevMonth = 12;
        prevYear--;
    }
    const prevMonthName = `${monthNames[prevMonth]} ${prevYear}`;
    
    content.innerHTML = `
        <div class="cmp-flow-row">
            <span class="cmp-flow-label">üî• Carry from ${prevMonthName}</span>
            <span class="cmp-flow-value inflow">${fmt(cmpDet.carry)}</span>
        </div>
        <div class="cmp-flow-row">
            <span class="cmp-flow-label">üí∞ ${currentMonthName} Income</span>
            <span class="cmp-flow-value inflow">+${fmt(cmpDet.inflow)}</span>
        </div>
        <div class="cmp-flow-row">
            <span class="cmp-flow-label">üí∏ ${currentMonthName} Outflows</span>
            <span class="cmp-flow-value outflow">-${fmt(cmpDet.outflow)}</span>
        </div>
        <div class="cmp-flow-row highlight">
            <span class="cmp-flow-label">üì§ Flowing to ${nextMonthName}</span>
            <span class="cmp-flow-value">${fmt(cmpDet.end)}</span>
        </div>
    `;
}

function renderStats(data) {
    const inf = data.inflows;
    const out = data.outflows;
    const bal = data.balances;
    const cmpDet = data.cmp_details;
    const invDet = data.investment_details;
    const mortDet = data.mortgage_details;
    const nwBreak = data.net_worth_breakdown;
    
    const totalIn = (inf.h_salary_net || 0) + (inf.w_salary_net || 0) + 
                    (inf.h_rsu_net || 0) + (inf.w_rsu_net || 0) + 
                    (inf.yt_net || 0) + (inf.ownsap_to_cmp || 0) + 
                    (inf.other_fam_net || 0);
    
    const totalOut = (out.mortgage_payment || 0) + 
                     (out.sondertilgung || 0) + 
                     (out.high_apr_payment || 0) + 
                     (out.low_apr_payment || 0) + 
                     (out.fixed_debt_payment || 0) + 
                     (out.sap_loan_payment || 0) + 
                     (out.expenses || 0) + 
                     (out.inv_ownsap || 0) + 
                     (out.inv_excess || 0) + 
                     (out.cash_add || 0);
    
    document.getElementById('statsRow').innerHTML = `
        <div class="stat-card">
            <div class="stat-label">Total Inflow</div>
            <div class="stat-value positive">${fmt(totalIn)}</div>
            <div class="stat-tooltip">
                <div class="stat-tooltip-row"><span class="stat-tooltip-label">H Salary</span><span class="stat-tooltip-value">${fmt(inf.h_salary_net)}</span></div>
                <div class="stat-tooltip-row"><span class="stat-tooltip-label">W Salary</span><span class="stat-tooltip-value">${fmt(inf.w_salary_net)}</span></div>
                <div class="stat-tooltip-row"><span class="stat-tooltip-label">H RSU</span><span class="stat-tooltip-value">${fmt(inf.h_rsu_net)}</span></div>
                <div class="stat-tooltip-row"><span class="stat-tooltip-label">W RSU</span><span class="stat-tooltip-value">${fmt(inf.w_rsu_net)}</span></div>
                <div class="stat-tooltip-row"><span class="stat-tooltip-label">YouTube</span><span class="stat-tooltip-value">${fmt(inf.yt_net)}</span></div>
                <div class="stat-tooltip-row"><span class="stat-tooltip-label">OWNSAP (Sold)</span><span class="stat-tooltip-value">${fmt(inf.ownsap_to_cmp)}</span></div>
                ${inf.other_fam_net ? `<div class="stat-tooltip-row"><span class="stat-tooltip-label">Other Family</span><span class="stat-tooltip-value">${fmt(inf.other_fam_net)}</span></div>` : ''}
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-label">Total Outflow</div>
            <div class="stat-value">${fmt(totalOut)}</div>
            <div class="stat-tooltip">
                <div class="stat-tooltip-row"><span class="stat-tooltip-label">Mortgage</span><span class="stat-tooltip-value">${fmt(out.mortgage_payment)}</span></div>
                <div class="stat-tooltip-row"><span class="stat-tooltip-label">Sondertilgung</span><span class="stat-tooltip-value">${fmt(out.sondertilgung)}</span></div>
                <div class="stat-tooltip-row"><span class="stat-tooltip-label">High-APR Debt</span><span class="stat-tooltip-value">${fmt(out.high_apr_payment)}</span></div>
                ${out.low_apr_payment ? `<div class="stat-tooltip-row"><span class="stat-tooltip-label">Low-APR Debt</span><span class="stat-tooltip-value">${fmt(out.low_apr_payment)}</span></div>` : ''}
                <div class="stat-tooltip-row"><span class="stat-tooltip-label">Fixed Loans</span><span class="stat-tooltip-value">${fmt(out.fixed_debt_payment)}</span></div>
                <div class="stat-tooltip-row"><span class="stat-tooltip-label">SAP Loan</span><span class="stat-tooltip-value">${fmt(out.sap_loan_payment)}</span></div>
                <div class="stat-tooltip-row"><span class="stat-tooltip-label">Expenses</span><span class="stat-tooltip-value">${fmt(out.expenses)}</span></div>
                <div class="stat-tooltip-row"><span class="stat-tooltip-label">To Investment</span><span class="stat-tooltip-value">${fmt(out.inv_ownsap + out.inv_excess)}</span></div>
                <div class="stat-tooltip-row"><span class="stat-tooltip-label">To Cashpile</span><span class="stat-tooltip-value">${fmt(out.cash_add)}</span></div>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-label">CMP Balance</div>
            <div class="stat-value">${fmt(bal.cmp)}</div>
            <div class="stat-tooltip">
                <div class="stat-tooltip-row"><span class="stat-tooltip-label">Carry Forward</span><span class="stat-tooltip-value">${fmt(cmpDet.carry)}</span></div>
                <div class="stat-tooltip-row"><span class="stat-tooltip-label">Inflow</span><span class="stat-tooltip-value">${fmt(cmpDet.inflow)}</span></div>
                <div class="stat-tooltip-row"><span class="stat-tooltip-label">Outflow</span><span class="stat-tooltip-value">${fmt(cmpDet.outflow)}</span></div>
                <div class="stat-tooltip-row"><span class="stat-tooltip-label">End Balance</span><span class="stat-tooltip-value">${fmt(cmpDet.end)}</span></div>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-label">Current Investment Value</div>
            <div class="stat-value positive">${fmt(bal.investment)}</div>
            <div class="stat-tooltip">
                <div class="stat-tooltip-row"><span class="stat-tooltip-label">Start Value</span><span class="stat-tooltip-value">${fmt(invDet.begin)}</span></div>
                <div class="stat-tooltip-row"><span class="stat-tooltip-label">OWNSAP Contrib</span><span class="stat-tooltip-value">${fmt(invDet.ownsap_contrib)}</span></div>
                <div class="stat-tooltip-row"><span class="stat-tooltip-label">Excess Contrib</span><span class="stat-tooltip-value">${fmt(invDet.excess_contrib)}</span></div>
                <div class="stat-tooltip-row"><span class="stat-tooltip-label">Growth</span><span class="stat-tooltip-value">${fmt(invDet.growth)}</span></div>
                <div class="stat-tooltip-row"><span class="stat-tooltip-label">End Value</span><span class="stat-tooltip-value">${fmt(invDet.end)}</span></div>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-label">Mortgage Left to Pay</div>
            <div class="stat-value ${bal.mortgage > 0 ? 'negative' : 'positive'}">${fmt(bal.mortgage)}</div>
            <div class="stat-tooltip">
                <div class="stat-tooltip-row"><span class="stat-tooltip-label">Original Balance</span><span class="stat-tooltip-value">${fmt(396554)}</span></div>
                <div class="stat-tooltip-row"><span class="stat-tooltip-label">Total Paid</span><span class="stat-tooltip-value">${fmt(mortDet.total_paid)}</span></div>
                <div class="stat-tooltip-row"><span class="stat-tooltip-label">Interest Rate</span><span class="stat-tooltip-value">${mortDet.interest_rate}%</span></div>
                <div class="stat-tooltip-row"><span class="stat-tooltip-label">Months Remaining</span><span class="stat-tooltip-value">~${mortDet.months_remaining}</span></div>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-label">Net Worth</div>
            <div class="stat-value positive">${fmt(bal.net_worth)}</div>
            <div class="stat-tooltip">
                <div class="stat-tooltip-row"><span class="stat-tooltip-label">Investment</span><span class="stat-tooltip-value">${fmt(nwBreak.investment)}</span></div>
                <div class="stat-tooltip-row"><span class="stat-tooltip-label">House Value</span><span class="stat-tooltip-value">${fmt(nwBreak.house)}</span></div>
                <div class="stat-tooltip-row"><span class="stat-tooltip-label">Mortgage</span><span class="stat-tooltip-value">${fmt(nwBreak.mortgage)}</span></div>
                <div class="stat-tooltip-row"><span class="stat-tooltip-label">Other Debt</span><span class="stat-tooltip-value">${fmt(nwBreak.other_debt)}</span></div>
                <div class="stat-tooltip-row"><span class="stat-tooltip-label">Time Account</span><span class="stat-tooltip-value">${fmt(nwBreak.time_account)}</span></div>
            </div>
        </div>
    `;
}

function renderSankey(data, dataArr) {
    const nodes = [];
    const links = [];
    const nodeMap = {};
    
    function addNode(name, color, clickable = false, clickHandler = null) {
        if (!nodeMap.hasOwnProperty(name)) {
            nodeMap[name] = nodes.length;
            nodes.push({ name, color, data: {}, clickable, clickHandler });
        }
        return nodeMap[name];
    }
    
    const inf = data.inflows;
    const out = data.outflows;
    const gross = data.gross;
    const ded = data.deductions;
    const debtDet = data.debt_details;
    const invDet = data.investment_details;
    const cmpDet = data.cmp_details;
    
    const showCMPCarry = isSingleMonthView() && cmpDet.carry > 0;
    
    if (viewMode === 'detailed') {
        // DETAILED VIEW: Gross ‚Üí Deductions ‚Üí Net ‚Üí CMP ‚Üí Outflows
        
        if (gross.h_salary > 0) {
            const grossIdx = addNode('H Gross Salary', colors.h_gross);
            nodes[grossIdx].data = { gross: gross.h_salary, ta: ded.h_ta, ownsap: ded.h_ownsap, tax: ded.h_tax, net: inf.h_salary_net };
            
            if (ded.h_ta > 0) {
                const taIdx = addNode('Time Account', colors.ta_deduction);
                links.push({ source: grossIdx, target: taIdx, value: ded.h_ta, color: colors.ta_deduction });
            }
            if (ded.h_ownsap > 0) {
                const ownsapIdx = addNode('OWNSAP Deduction', colors.ownsap_ded);
                links.push({ source: grossIdx, target: ownsapIdx, value: ded.h_ownsap, color: colors.ownsap_ded });
            }
            if (ded.h_tax > 0) {
                const taxIdx = addNode('Tax & Social', colors.tax);
                links.push({ source: grossIdx, target: taxIdx, value: ded.h_tax, color: colors.tax });
            }
            
            if (inf.h_salary_net > 0) {
                const netIdx = addNode('H Net Salary', colors.h_salary);
                const cmpIdx = addNode('CMP', colors.cmp);
                links.push({ source: grossIdx, target: netIdx, value: inf.h_salary_net, color: colors.h_salary });
                links.push({ source: netIdx, target: cmpIdx, value: inf.h_salary_net, color: colors.h_salary });
            }
        }
        
        if (gross.w_salary > 0) {
            const grossIdx = addNode('W Gross Salary', colors.w_gross);
            nodes[grossIdx].data = { gross: gross.w_salary, ta: ded.w_ta, ownsap: ded.w_ownsap, tax: ded.w_tax, net: inf.w_salary_net };
            
            if (ded.w_ta > 0) {
                let taIdx = nodeMap['Time Account'];
                if (taIdx === undefined) taIdx = addNode('Time Account', colors.ta_deduction);
                links.push({ source: grossIdx, target: taIdx, value: ded.w_ta, color: colors.ta_deduction });
            }
            if (ded.w_ownsap > 0) {
                let ownsapIdx = nodeMap['OWNSAP Deduction'];
                if (ownsapIdx === undefined) ownsapIdx = addNode('OWNSAP Deduction', colors.ownsap_ded);
                links.push({ source: grossIdx, target: ownsapIdx, value: ded.w_ownsap, color: colors.ownsap_ded });
            }
            if (ded.w_tax > 0) {
                let taxIdx = nodeMap['Tax & Social'];
                if (taxIdx === undefined) taxIdx = addNode('Tax & Social', colors.tax);
                links.push({ source: grossIdx, target: taxIdx, value: ded.w_tax, color: colors.tax });
            }
            
            if (inf.w_salary_net > 0) {
                const netIdx = addNode('W Net Salary', colors.w_salary);
                const cmpIdx = addNode('CMP', colors.cmp);
                links.push({ source: grossIdx, target: netIdx, value: inf.w_salary_net, color: colors.w_salary });
                links.push({ source: netIdx, target: cmpIdx, value: inf.w_salary_net, color: colors.w_salary });
            }
        }
        
        // Other income directly to CMP in detailed view
        const cmpIdx = addNode('CMP', colors.cmp);
        
        if (inf.h_rsu_net > 0) {
            const idx = addNode('H RSU', colors.h_rsu);
            links.push({ source: idx, target: cmpIdx, value: inf.h_rsu_net, color: colors.h_rsu });
        }
        if (inf.w_rsu_net > 0) {
            const idx = addNode('W RSU', colors.w_rsu);
            links.push({ source: idx, target: cmpIdx, value: inf.w_rsu_net, color: colors.w_rsu });
        }
        if (inf.yt_net > 0) {
            const idx = addNode('YouTube', colors.youtube);
            links.push({ source: idx, target: cmpIdx, value: inf.yt_net, color: colors.youtube });
        }
        if (inf.ownsap_to_cmp > 0) {
            const idx = addNode('OWNSAP Sold', colors.ownsap_sell);
            links.push({ source: idx, target: cmpIdx, value: inf.ownsap_to_cmp, color: colors.ownsap_sell });
        }
        if (inf.other_fam_net && inf.other_fam_net > 0) {
            const idx = addNode('Other Family', colors.h_salary);
            links.push({ source: idx, target: cmpIdx, value: inf.other_fam_net, color: colors.h_salary });
        }
        if (showCMPCarry) {
            const idx = addNode('Prev Month CMP', colors.cmp_carry);
            links.push({ source: idx, target: cmpIdx, value: cmpDet.carry, color: colors.cmp_carry });
        }
        
    } else {
        // SIMPLE VIEW: Net income ‚Üí CMP ‚Üí Outflows
        const cmpIdx = addNode('CMP', colors.cmp);
        
        if (inf.h_salary_net > 0) {
            const idx = addNode('H Salary', colors.h_salary);
            links.push({ source: idx, target: cmpIdx, value: inf.h_salary_net, color: colors.h_salary });
        }
        if (inf.w_salary_net > 0) {
            const idx = addNode('W Salary', colors.w_salary);
            links.push({ source: idx, target: cmpIdx, value: inf.w_salary_net, color: colors.w_salary });
        }
        if (inf.h_rsu_net > 0) {
            const idx = addNode('H RSU', colors.h_rsu);
            links.push({ source: idx, target: cmpIdx, value: inf.h_rsu_net, color: colors.h_rsu });
        }
        if (inf.w_rsu_net > 0) {
            const idx = addNode('W RSU', colors.w_rsu);
            links.push({ source: idx, target: cmpIdx, value: inf.w_rsu_net, color: colors.w_rsu });
        }
        if (inf.yt_net > 0) {
            const idx = addNode('YouTube', colors.youtube);
            links.push({ source: idx, target: cmpIdx, value: inf.yt_net, color: colors.youtube });
        }
        if (inf.ownsap_to_cmp > 0) {
            const idx = addNode('OWNSAP Sold', colors.ownsap_sell);
            links.push({ source: idx, target: cmpIdx, value: inf.ownsap_to_cmp, color: colors.ownsap_sell });
        }
        if (inf.other_fam_net && inf.other_fam_net > 0) {
            const idx = addNode('Other Family', colors.h_salary);
            links.push({ source: idx, target: cmpIdx, value: inf.other_fam_net, color: colors.h_salary });
        }
        if (showCMPCarry) {
            const idx = addNode('Prev Month CMP', colors.cmp_carry);
            links.push({ source: idx, target: cmpIdx, value: cmpDet.carry, color: colors.cmp_carry });
        }
    }
    
    // OUTFLOWS from CMP
    const cmpIdx = nodeMap['CMP'];
    
    if (out.mortgage_payment > 0) {
        const idx = addNode('Mortgage', colors.mortgage);
        nodes[idx].data = {
            payment: out.mortgage_payment,
            principal: out.mortgage_principal,
            interest: out.mortgage_interest
        };
        links.push({ source: cmpIdx, target: idx, value: out.mortgage_payment, color: colors.mortgage });
    }
    if (out.sondertilgung > 0) {
        const idx = addNode('Sondertilgung', colors.sondertilgung);
        links.push({ source: cmpIdx, target: idx, value: out.sondertilgung, color: colors.sondertilgung });
    }
    if (out.high_apr_payment > 0) {
        const idx = addNode('High-APR Debt', colors.high_apr, true, () => showDebtModal('high-apr', debtDet));
        nodes[idx].data = debtDet;
        links.push({ source: cmpIdx, target: idx, value: out.high_apr_payment, color: colors.high_apr });
    }
    if (out.low_apr_payment && out.low_apr_payment > 0) {
        const idx = addNode('Low-APR Debt', colors.low_apr, true, () => showDebtModal('low-apr', debtDet));
        nodes[idx].data = debtDet;
        links.push({ source: cmpIdx, target: idx, value: out.low_apr_payment, color: colors.low_apr });
    }
    if (out.fixed_debt_payment > 0) {
        const idx = addNode('Fixed Loans', colors.fixed_debt, true, () => showDebtModal('fixed', debtDet));
        nodes[idx].data = debtDet;
        links.push({ source: cmpIdx, target: idx, value: out.fixed_debt_payment, color: colors.fixed_debt });
    }
    if (out.sap_loan_payment > 0) {
        const idx = addNode('SAP Loan', colors.sap_loan, true, () => showDebtModal('sap', debtDet));
        nodes[idx].data = { payment: out.sap_loan_payment, balance: debtDet.sap?.balance || 0 };
        links.push({ source: cmpIdx, target: idx, value: out.sap_loan_payment, color: colors.sap_loan });
    }
    
    // EXPENSES - NEW in v3.1: Conditional collapsed/expanded view
    if (out.expenses > 0) {
        if (expenseView === 'expanded' && currentExpenseData && currentExpenseData.success && currentExpenseData.categories) {
            // EXPANDED VIEW: Show individual category nodes
            const MIN_AMOUNT = 10; // Minimum ‚Ç¨10 to show as separate node
            
            currentExpenseData.categories
                .filter(cat => cat.spent >= MIN_AMOUNT)
                .forEach(cat => {
                    const idx = addNode(cat.name, getCategoryColor(cat.name), true, () => showExpenseModal());
                    nodes[idx].data = { 
                        spent: cat.spent, 
                        budget: cat.budget, 
                        percent: cat.percent,
                        status: cat.status 
                    };
                    links.push({ source: cmpIdx, target: idx, value: cat.spent, color: getCategoryColor(cat.name) });
                });
            
            // Add "Other" node for small categories
            const smallTotal = currentExpenseData.categories
                .filter(cat => cat.spent > 0 && cat.spent < MIN_AMOUNT)
                .reduce((sum, cat) => sum + cat.spent, 0);
            
            if (smallTotal > 0) {
                const idx = addNode('Other Expenses', colors.expenses, true, () => showExpenseModal());
                links.push({ source: cmpIdx, target: idx, value: smallTotal, color: colors.expenses });
            }
        } else {
            // COLLAPSED VIEW: Single expenses node
            const idx = addNode('Expenses', colors.expenses, true, () => showExpenseModal());
            nodes[idx].data = { budget: out.expenses };
            links.push({ source: cmpIdx, target: idx, value: out.expenses, color: colors.expenses });
        }
    }
    
    // Investment flows
    if (out.inv_ownsap > 0) {
        const invIdx = addNode('Investment', colors.investment);
        const ownsapIdx = addNode('OWNSAP', colors.ownsap_inv);
        nodes[invIdx].data = invDet;
        links.push({ source: ownsapIdx, target: invIdx, value: out.inv_ownsap, color: colors.ownsap_inv });
    }
    if (out.inv_excess > 0) {
        let invIdx = nodeMap['Investment'];
        if (invIdx === undefined) {
            invIdx = addNode('Investment', colors.investment);
            nodes[invIdx].data = invDet;
        }
        links.push({ source: cmpIdx, target: invIdx, value: out.inv_excess, color: colors.investment });
    }
    if (out.cash_add > 0) {
        const idx = addNode('Cashpile', colors.cashpile);
        links.push({ source: cmpIdx, target: idx, value: out.cash_add, color: colors.cashpile });
    }
    
    // For single month view, add "Next Month CMP" as outflow
    if (isSingleMonthView() && cmpDet.end > 0) {
        const nextIdx = addNode('Next Month CMP', colors.cmp_next);
        links.push({ source: cmpIdx, target: nextIdx, value: cmpDet.end, color: colors.cmp_next });
    }
    
    drawSankey(nodes, links);
    updateLegend(nodes);
}

function drawSankey(nodes, links) {
    const container = document.getElementById('sankey');
    container.innerHTML = '';
    
    if (links.length === 0) {
        container.innerHTML = '<div class="loading"><span>No flow data for this period</span></div>';
        return;
    }
    
    const width = container.clientWidth;
    const height = Math.max(500, nodes.length * 50);
    
    const svg = d3.select('#sankey')
        .append('svg')
        .attr('width', width)
        .attr('height', height);
    
    const sankey = d3.sankey()
        .nodeWidth(20)
        .nodePadding(18)
        .extent([[1, 1], [width - 1, height - 6]]);
    
    const graph = sankey({
        nodes: nodes.map(d => ({ ...d })),
        links: links.map(d => ({ ...d }))
    });
    
    // Links
    svg.append('g')
        .selectAll('path')
        .data(graph.links)
        .join('path')
        .attr('class', 'link')
        .attr('d', d3.sankeyLinkHorizontal())
        .attr('stroke', d => d.color)
        .attr('stroke-width', d => Math.max(1, d.width))
        .on('mouseover', showLinkTooltip)
        .on('mousemove', moveTooltip)
        .on('mouseout', hideTooltip);
    
    // Nodes
    const node = svg.append('g')
        .selectAll('g')
        .data(graph.nodes)
        .join('g')
        .attr('class', 'node');
    
    node.append('rect')
        .attr('x', d => d.x0)
        .attr('y', d => d.y0)
        .attr('height', d => d.y1 - d.y0)
        .attr('width', d => d.x1 - d.x0)
        .attr('fill', d => d.color)
        .attr('rx', 3)
        .style('cursor', d => d.clickable ? 'pointer' : 'default')
        .on('mouseover', showNodeTooltip)
        .on('mousemove', moveTooltip)
        .on('mouseout', hideTooltip)
        .on('click', (event, d) => {
            if (d.clickable && d.clickHandler) {
                d.clickHandler();
            }
        });
    
    node.append('text')
        .attr('x', d => d.x0 < width / 2 ? d.x1 + 6 : d.x0 - 6)
        .attr('y', d => (d.y1 + d.y0) / 2)
        .attr('dy', '0.35em')
        .attr('text-anchor', d => d.x0 < width / 2 ? 'start' : 'end')
        .text(d => `${d.name}: ${fmt(d.value)}`);
}

// ============ MODALS ============

async function showExpenseModal() {
    openModal('expenseModal');
    const content = document.getElementById('expenseModalContent');
    content.innerHTML = '<div class="loading"><div class="spinner"></div><span>Loading expense data from ShadowLedger...</span></div>';
    
    const months = [];
    for (let m = monthFrom; m <= monthTo; m++) {
        months.push(getMonthKey(currentYear, m));
    }
    
    try {
        const results = await Promise.all(months.map(m => fetchExpenseData(m)));
        let aggregated = aggregateExpenseData(results);
        renderExpenseModalContent(aggregated, months.length > 1);
    } catch (err) {
        content.innerHTML = `<div class="error">Failed to load expense data: ${err.message}</div>`;
    }
}

function aggregateExpenseData(results) {
    try {
        if (!results || results.length === 0) {
            return { success: false, error: 'No data' };
        }
        
        // Filter to only successful results with valid expense data
        const validResults = results.filter(r => r && r.success !== false && r.categories && r.summary);
        
        console.log('[Expense] Valid results:', validResults.length, 'of', results.length);
        
        if (validResults.length === 0) {
            const firstErr = results[0]?.error || 'No valid expense data';
            return { success: false, error: firstErr };
        }
        
        if (validResults.length === 1) return validResults[0];
        
        const agg = {
            success: true,
            month: `${validResults[0].month || ''} - ${validResults[validResults.length-1].month || ''}`,
            month_name: `${validResults[0].month_name || ''} - ${validResults[validResults.length-1].month_name || ''}`,
            categories: [],
            summary: {
                total_spent: 0,
                total_budget: 0,
                transaction_count: 0,
                budget_available: false
            }
        };
        
        const catMap = {};
        
        validResults.forEach(r => {
            if (r.categories && Array.isArray(r.categories)) {
                r.categories.forEach(cat => {
                    if (!cat || !cat.name) return;
                    if (!catMap[cat.name]) {
                        catMap[cat.name] = { name: cat.name, spent: 0, budget: 0, hasBudget: false };
                    }
                    catMap[cat.name].spent += cat.spent || 0;
                    if (cat.budget !== null && cat.budget !== undefined) {
                        catMap[cat.name].budget += cat.budget;
                        catMap[cat.name].hasBudget = true;
                    }
                });
            }
            
            if (r.summary) {
                agg.summary.total_spent += r.summary.total_spent || 0;
                if (r.summary.total_budget) {
                    agg.summary.total_budget += r.summary.total_budget;
                    agg.summary.budget_available = true;
                }
                agg.summary.transaction_count += r.summary.transaction_count || 0;
            }
        });
        
        agg.categories = Object.values(catMap).map(cat => ({
            name: cat.name,
            spent: cat.spent,
            budget: cat.hasBudget ? cat.budget : null,
            percent: cat.hasBudget && cat.budget > 0 ? Math.round((cat.spent / cat.budget) * 100) : null,
            status: cat.hasBudget && cat.budget > 0 ? getStatusEmoji(Math.round((cat.spent / cat.budget) * 100)) : 'N/A'
        })).sort((a, b) => b.spent - a.spent);
        
        if (agg.summary.budget_available && agg.summary.total_budget > 0) {
            agg.summary.total_percent = Math.round((agg.summary.total_spent / agg.summary.total_budget) * 100);
        }
        
        return agg;
    } catch (err) {
        console.error('Error aggregating expense data:', err);
        return { success: false, error: 'Error processing expense data: ' + err.message };
    }
}

function getStatusEmoji(percent) {
    if (percent >= 100) return 'üî¥';
    if (percent >= 80) return 'üü†';
    if (percent >= 50) return 'üü°';
    return 'üü¢';
}

function getBarColor(percent) {
    if (percent >= 100) return 'red';
    if (percent >= 80) return 'orange';
    if (percent >= 50) return 'yellow';
    return 'green';
}

function renderExpenseModalContent(data, isMultiMonth) {
    const content = document.getElementById('expenseModalContent');
    
    try {
        if (!data || !data.success) {
            content.innerHTML = `<div class="error">${data?.error || 'Failed to load data'}</div>`;
            return;
        }
        
        // Handle missing summary entirely
        if (!data.summary) {
            content.innerHTML = `
                <div class="budget-na">
                    <p>üìä <strong>${data.month_name || 'Unknown period'}</strong></p>
                    <p style="margin-top: 12px;">No expense data available for this period.</p>
                    <p style="margin-top: 16px; font-size: 12px;">Ensure ShadowLedger is configured and has transactions for this month.</p>
                </div>
            `;
            return;
        }
        
        if (!data.summary.budget_available) {
            content.innerHTML = `
                <div class="budget-na">
                    <p>üìä <strong>${data.month_name || 'Unknown period'}</strong></p>
                    <p style="margin-top: 12px;">Budget data not available for this period.</p>
                    <p style="margin-top: 8px; font-size: 12px;">Total spent: ${fmt(data.summary.total_spent || 0)} (${data.summary.transaction_count || 0} transactions)</p>
                    <p style="margin-top: 16px; font-size: 12px;">To enable budget tracking, add rows for this month in the SL_Budget tab.</p>
                </div>
            `;
            return;
        }
        
        let html = `<p style="margin-bottom: 16px; color: var(--text-secondary);">üìÖ ${data.month_name || ''} ‚Ä¢ ${data.summary.transaction_count || 0} transactions</p>`;
        
        if (data.categories && Array.isArray(data.categories)) {
            data.categories.forEach(cat => {
                if (!cat || (cat.spent === 0 && (!cat.budget || cat.budget === 0))) return;
                
                const percent = cat.percent !== null ? cat.percent : 0;
                const barWidth = Math.min(percent, 100);
                const budgetStr = cat.budget !== null ? fmt(cat.budget) : 'N/A';
                const percentStr = cat.percent !== null ? `${cat.percent}%` : 'N/A';
                
                html += `
                    <div class="budget-item">
                        <div class="budget-item-header">
                            <span class="budget-item-name">${cat.status || ''} ${cat.name || 'Unknown'}</span>
                            <span class="budget-item-values">${fmt(cat.spent || 0)} / ${budgetStr} (${percentStr})</span>
                        </div>
                        <div class="budget-bar">
                            <div class="budget-bar-fill ${getBarColor(percent)}" style="width: ${barWidth}%"></div>
                        </div>
                    </div>
                `;
            });
        }
        
        const totalPercent = data.summary.total_percent !== null && data.summary.total_percent !== undefined ? `${data.summary.total_percent}%` : 'N/A';
        const totalBudget = data.summary.total_budget ? fmt(data.summary.total_budget) : 'N/A';
        
        html += `
            <div class="budget-summary">
                <span>Total</span>
                <span>${fmt(data.summary.total_spent || 0)} / ${totalBudget} (${totalPercent})</span>
            </div>
        `;
        
        content.innerHTML = html;
    } catch (err) {
        console.error('Error rendering expense modal:', err);
        content.innerHTML = `<div class="error">Error displaying expense data: ${err.message}</div>`;
    }
}

function showDebtModal(type, debtDet) {
    openModal('debtModal');
    const title = document.getElementById('debtModalTitle');
    const content = document.getElementById('debtModalContent');
    
    let html = '';
    
    if (type === 'high-apr') {
        title.textContent = 'üî• High-APR Debt Breakdown';
        html = `
            <div class="debt-section">
                <div class="debt-section-title">Debts (Highest APR First)</div>
                ${renderDebtItem('TF Bank', debtDet.tf, '24% APR')}
                ${renderDebtItem('Deutsche Bank', debtDet.db, '15% APR')}
                ${renderDebtItem('Klarna', debtDet.klarna, '15% APR')}
                ${renderDebtItem('Nordea', debtDet.nordea, '8% APR')}
                ${renderDebtItem('Aktia', debtDet.aktia, '6% APR')}
            </div>
        `;
    } else if (type === 'low-apr') {
        title.textContent = 'üìâ Low-APR Debt Breakdown';
        html = `
            <div class="debt-section">
                <div class="debt-section-title">Low-APR Debts</div>
                ${debtDet.scalable ? renderDebtItem('Scalable Credit', debtDet.scalable, '3.3% APR') : ''}
                ${debtDet.ak ? renderDebtItem('AK Payback', debtDet.ak, '0% APR') : ''}
            </div>
        `;
    } else if (type === 'fixed') {
        title.textContent = 'üìã Fixed Loans Breakdown';
        html = `
            <div class="debt-section">
                <div class="debt-section-title">Fixed Payment Loans</div>
                ${renderDebtItem('Revolut', debtDet.revolut, 'Fixed')}
                ${renderDebtItem('C3 Family', debtDet.c3, 'Fixed')}
                ${renderDebtItem('Student Loan', debtDet.student, 'Fixed')}
                ${renderDebtItem('IKEA Card', debtDet.ikea, 'Fixed')}
                ${renderDebtItem('N26 Overdraft', debtDet.n26, 'Fixed')}
            </div>
        `;
    } else if (type === 'sap') {
        title.textContent = 'üè¢ SAP Loan Details';
        html = `
            <div class="debt-section">
                <div class="debt-section-title">SAP Employee Loan (0% APR)</div>
                ${renderDebtItem('Total SAP Loan', debtDet.sap, 'Until Jun 2033')}
                ${debtDet.sap?.h_balance !== undefined ? `
                    <div class="debt-item" style="margin-top: 12px;">
                        <span class="debt-item-name" style="color: var(--text-secondary);">Breakdown:</span>
                    </div>
                    <div class="debt-item">
                        <span class="debt-item-name">Husband's Loan</span>
                        <span class="debt-item-values"><span class="balance">${fmt(debtDet.sap.h_balance)}</span></span>
                    </div>
                    <div class="debt-item">
                        <span class="debt-item-name">Wife's Loan</span>
                        <span class="debt-item-values"><span class="balance">${fmt(debtDet.sap.w_balance)}</span></span>
                    </div>
                ` : ''}
            </div>
        `;
    }
    
    content.innerHTML = html;
}

function renderDebtItem(name, debt, info) {
    if (!debt) return '';
    const payment = debt.payment || 0;
    const balance = debt.balance || 0;
    
    if (payment === 0 && balance === 0) return '';
    
    return `
        <div class="debt-item">
            <span class="debt-item-name">${name} <span style="color: var(--text-muted); font-size: 11px;">${info}</span></span>
            <div class="debt-item-values">
                <span class="payment">${fmt(payment)}/mo</span>
                <span class="balance">Bal: ${fmt(balance)}</span>
            </div>
        </div>
    `;
}

// ============ TOOLTIPS ============

function showLinkTooltip(event, d) {
    const tooltip = document.getElementById('tooltip');
    tooltip.innerHTML = `
        <div class="tooltip-title">${d.source.name} ‚Üí ${d.target.name}</div>
        <div class="tooltip-row"><span class="tooltip-label">Amount</span><span class="tooltip-value">${fmt(d.value)}</span></div>
    `;
    tooltip.classList.add('visible');
    moveTooltip(event);
}

function showNodeTooltip(event, d) {
    const tooltip = document.getElementById('tooltip');
    let html = `<div class="tooltip-title">${d.name}</div>`;
    html += `<div class="tooltip-row"><span class="tooltip-label">Total</span><span class="tooltip-value">${fmt(d.value)}</span></div>`;
    
    const data = d.data;
    const debtDet = data;
    
    // Show relevant details based on node type
    if (d.name === 'Expenses') {
        // Collapsed expenses node - show all categories on hover
        if (currentExpenseData && currentExpenseData.success && currentExpenseData.categories && currentExpenseData.summary) {
            html += `<div class="tooltip-divider"></div>`;
            html += `<div style="max-height: 350px; overflow-y: auto;">`;
            currentExpenseData.categories.forEach(cat => {
                const budgetStr = cat.budget !== null ? fmt(cat.budget) : 'N/A';
                const spentStr = fmt(cat.spent);
                html += `<div class="tooltip-row"><span class="tooltip-label">${cat.status} ${cat.name}</span><span class="tooltip-value">${spentStr} / ${budgetStr}</span></div>`;
            });
            html += `</div>`;
            html += `<div class="tooltip-divider"></div>`;
            const totalBudget = currentExpenseData.summary.total_budget ? fmt(currentExpenseData.summary.total_budget) : 'N/A';
            const totalPct = currentExpenseData.summary.total_percent !== null ? `(${currentExpenseData.summary.total_percent}%)` : '';
            html += `<div class="tooltip-row" style="font-weight:600;"><span class="tooltip-label">TOTAL</span><span class="tooltip-value">${fmt(currentExpenseData.summary.total_spent || 0)} / ${totalBudget} ${totalPct}</span></div>`;
            html += `<div class="tooltip-hint">Click for detailed view with budget bars</div>`;
        } else {
            html += `<div class="tooltip-hint">Click for category breakdown</div>`;
        }
    } else if (categoryColors[d.name]) {
        // Individual expense category node (expanded view)
        if (data.budget !== null) {
            html += `<div class="tooltip-divider"></div>`;
            html += `<div class="tooltip-row"><span class="tooltip-label">Spent</span><span class="tooltip-value">${fmt(data.spent)}</span></div>`;
            html += `<div class="tooltip-row"><span class="tooltip-label">Budget</span><span class="tooltip-value">${fmt(data.budget)}</span></div>`;
            html += `<div class="tooltip-row"><span class="tooltip-label">Status</span><span class="tooltip-value">${data.status} ${data.percent}%</span></div>`;
        }
        html += `<div class="tooltip-hint">Click for full expense breakdown</div>`;
    } else if (d.name === 'Mortgage') {
        html += `
            <div class="tooltip-divider"></div>
            <div class="tooltip-row"><span class="tooltip-label">Monthly Payment</span><span class="tooltip-value">${fmt(data.payment || d.value)}</span></div>
            <div class="tooltip-row"><span class="tooltip-label">‚Üí Principal</span><span class="tooltip-value">${fmt(data.principal || 0)}</span></div>
            <div class="tooltip-row"><span class="tooltip-label">‚Üí Interest</span><span class="tooltip-value">${fmt(data.interest || 0)}</span></div>
        `;
    } else if (d.name.includes('High-APR')) {
        html += `<div class="tooltip-divider"></div>`;
        if (debtDet.tf) html += `<div class="tooltip-row"><span class="tooltip-label">TF Bank (24%)</span><span class="tooltip-value">${fmt(debtDet.tf.payment)}/mo ‚Ä¢ Bal: ${fmt(debtDet.tf.balance)}</span></div>`;
        if (debtDet.db) html += `<div class="tooltip-row"><span class="tooltip-label">Deutsche Bank (15%)</span><span class="tooltip-value">${fmt(debtDet.db.payment)}/mo ‚Ä¢ Bal: ${fmt(debtDet.db.balance)}</span></div>`;
        if (debtDet.klarna) html += `<div class="tooltip-row"><span class="tooltip-label">Klarna (15%)</span><span class="tooltip-value">${fmt(debtDet.klarna.payment)}/mo ‚Ä¢ Bal: ${fmt(debtDet.klarna.balance)}</span></div>`;
        if (debtDet.nordea) html += `<div class="tooltip-row"><span class="tooltip-label">Nordea (8%)</span><span class="tooltip-value">${fmt(debtDet.nordea.payment)}/mo ‚Ä¢ Bal: ${fmt(debtDet.nordea.balance)}</span></div>`;
        if (debtDet.aktia) html += `<div class="tooltip-row"><span class="tooltip-label">Aktia (6%)</span><span class="tooltip-value">${fmt(debtDet.aktia.payment)}/mo ‚Ä¢ Bal: ${fmt(debtDet.aktia.balance)}</span></div>`;
        html += `<div class="tooltip-hint">Click for detailed breakdown</div>`;
    } else if (d.name.includes('Low-APR')) {
        html += `<div class="tooltip-divider"></div>`;
        if (debtDet.scalable) html += `<div class="tooltip-row"><span class="tooltip-label">Scalable (3.3%)</span><span class="tooltip-value">${fmt(debtDet.scalable.payment)}/mo ‚Ä¢ Bal: ${fmt(debtDet.scalable.balance)}</span></div>`;
        if (debtDet.ak) html += `<div class="tooltip-row"><span class="tooltip-label">AK Payback (0%)</span><span class="tooltip-value">${fmt(debtDet.ak.payment)}/mo ‚Ä¢ Bal: ${fmt(debtDet.ak.balance)}</span></div>`;
        html += `<div class="tooltip-hint">Click for detailed breakdown</div>`;
    } else if (d.name === 'Fixed Loans') {
        html += `<div class="tooltip-divider"></div>`;
        if (debtDet.revolut) html += `<div class="tooltip-row"><span class="tooltip-label">Revolut</span><span class="tooltip-value">${fmt(debtDet.revolut.payment)}/mo</span></div>`;
        if (debtDet.c3) html += `<div class="tooltip-row"><span class="tooltip-label">C3 Family</span><span class="tooltip-value">${fmt(debtDet.c3.payment)}/mo</span></div>`;
        if (debtDet.student) html += `<div class="tooltip-row"><span class="tooltip-label">Student Loan</span><span class="tooltip-value">${fmt(debtDet.student.payment)}/mo</span></div>`;
        if (debtDet.ikea) html += `<div class="tooltip-row"><span class="tooltip-label">IKEA Card</span><span class="tooltip-value">${fmt(debtDet.ikea.payment)}/mo</span></div>`;
        if (debtDet.n26) html += `<div class="tooltip-row"><span class="tooltip-label">N26 Overdraft</span><span class="tooltip-value">${fmt(debtDet.n26.payment)}/mo</span></div>`;
        html += `<div class="tooltip-hint">Click for balances & details</div>`;
    } else if (d.name === 'SAP Loan') {
        html += `<div class="tooltip-divider"></div>`;
        html += `<div class="tooltip-row"><span class="tooltip-label">Monthly Payment</span><span class="tooltip-value">${fmt(data.payment || d.value)}</span></div>`;
        html += `<div class="tooltip-row"><span class="tooltip-label">Remaining Balance</span><span class="tooltip-value">${fmt(data.balance || 0)}</span></div>`;
        html += `<div class="tooltip-row"><span class="tooltip-label">Interest Rate</span><span class="tooltip-value">0% (employee benefit)</span></div>`;
        html += `<div class="tooltip-hint">Click for H/W breakdown</div>`;
    } else if (d.name === 'Investment' && data.begin !== undefined) {
        html += `
            <div class="tooltip-divider"></div>
            <div class="tooltip-row"><span class="tooltip-label">Start</span><span class="tooltip-value">${fmt(data.begin)}</span></div>
            <div class="tooltip-row"><span class="tooltip-label">OWNSAP</span><span class="tooltip-value">${fmt(data.ownsap_contrib)}</span></div>
            <div class="tooltip-row"><span class="tooltip-label">Excess</span><span class="tooltip-value">${fmt(data.excess_contrib)}</span></div>
            <div class="tooltip-row"><span class="tooltip-label">Growth</span><span class="tooltip-value">${fmt(data.growth)}</span></div>
            <div class="tooltip-row"><span class="tooltip-label">End</span><span class="tooltip-value">${fmt(data.end)}</span></div>
        `;
    } else if (d.name.includes('Gross') && data.gross) {
        html += `
            <div class="tooltip-divider"></div>
            <div class="tooltip-row"><span class="tooltip-label">Gross</span><span class="tooltip-value">${fmt(data.gross)}</span></div>
            <div class="tooltip-row"><span class="tooltip-label">Time Account</span><span class="tooltip-value">-${fmt(data.ta)}</span></div>
            <div class="tooltip-row"><span class="tooltip-label">OWNSAP</span><span class="tooltip-value">-${fmt(data.ownsap)}</span></div>
            <div class="tooltip-row"><span class="tooltip-label">Tax & Social</span><span class="tooltip-value">-${fmt(data.tax)}</span></div>
            <div class="tooltip-divider"></div>
            <div class="tooltip-row"><span class="tooltip-label">Net</span><span class="tooltip-value">${fmt(data.net)}</span></div>
        `;
    }
    
    tooltip.innerHTML = html;
    tooltip.classList.add('visible');
    moveTooltip(event);
}

function moveTooltip(event) {
    const tooltip = document.getElementById('tooltip');
    const tooltipRect = tooltip.getBoundingClientRect();
    const padding = 15;
    
    // Use clientX/clientY for fixed positioning
    let x = event.clientX + padding;
    let y = event.clientY - padding;
    
    // Prevent tooltip from going off-screen right
    if (x + tooltipRect.width > window.innerWidth - padding) {
        x = event.clientX - tooltipRect.width - padding;
    }
    
    // Prevent tooltip from going off-screen bottom
    if (y + tooltipRect.height > window.innerHeight - padding) {
        y = window.innerHeight - tooltipRect.height - padding;
    }
    
    // Prevent tooltip from going off-screen top
    if (y < padding) {
        y = padding;
    }
    
    // Prevent tooltip from going off-screen left
    if (x < padding) {
        x = padding;
    }
    
    tooltip.style.left = `${x}px`;
    tooltip.style.top = `${y}px`;
}

function hideTooltip() {
    document.getElementById('tooltip').classList.remove('visible');
}

function updateLegend(nodes) {
    const uniqueColors = [...new Set(nodes.map(n => n.color))];
    const legend = document.getElementById('legend');
    
    const colorNames = {
        [colors.h_salary]: 'H Income',
        [colors.w_salary]: 'W Income',
        [colors.h_rsu]: 'H RSU',
        [colors.w_rsu]: 'W RSU',
        [colors.youtube]: 'YouTube',
        [colors.ownsap_sell]: 'OWNSAP Sold',
        [colors.cmp]: 'CMP',
        [colors.cmp_carry]: 'CMP Carry',
        [colors.cmp_next]: 'To Next Month',
        [colors.mortgage]: 'Mortgage',
        [colors.sondertilgung]: 'Sondertilgung',
        [colors.high_apr]: 'High-APR Debt',
        [colors.low_apr]: 'Low-APR Debt',
        [colors.fixed_debt]: 'Fixed Loans',
        [colors.sap_loan]: 'SAP Loan',
        [colors.expenses]: 'Expenses',
        [colors.investment]: 'Investment',
        [colors.cashpile]: 'Cashpile',
        [colors.tax]: 'Tax & Deductions',
        [colors.ta_deduction]: 'Time Account',
        [colors.ownsap_ded]: 'OWNSAP Ded.',
    };
    
    // Add category colors to legend names
    Object.entries(categoryColors).forEach(([name, color]) => {
        colorNames[color] = name;
    });
    
    legend.innerHTML = uniqueColors
        .filter(c => colorNames[c])
        .map(c => `<div class="legend-item"><div class="legend-color" style="background:${c}"></div>${colorNames[c]}</div>`)
        .join('');
}
</script>
</body>
</html>